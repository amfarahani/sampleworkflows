# Typical CI/CD workflow used in real projects
# Build runs on every branch, deploy runs only on main
name: CI Pipeline â€“ Build and Deploy

run-name: CI run by ${{ github.actor }} on ${{ github.ref_name }}

on:
  push:                   # Run pipeline on every push
  workflow_dispatch:      # Allow manual execution

env:
  APP_NAME: "web-application"
  DEPLOY_BRANCH: "main"   # Only main branch is allowed to deploy

jobs:

  # ------------------------------------------------------
  # BUILD JOB
  # ------------------------------------------------------
  build:
    runs-on: ubuntu-latest

    # Expose build version to downstream jobs
    outputs:
      build_version: ${{ steps.version.outputs.build_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4      # Pull repo onto runner

      - name: Create build version
        id: version                     # Required for step outputs
        run: |
          VERSION="v${{ github.run_number }}-${GITHUB_SHA::7}"
          echo "build_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Build version created: $VERSION"

      - name: Display build version
        run: |
          echo "Build version = ${{ steps.version.outputs.build_version }}"

  # ------------------------------------------------------
  # TEST JOB
  # ------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    needs: build                        # Wait for build job
    steps:
      - name: Run tests (simulated)
        run: |
          echo "Running tests on build:"
          echo "${{ needs.build.outputs.build_version }}"
          echo "All tests passed."

  # ------------------------------------------------------
  # DEPLOY JOB (MAIN BRANCH ONLY)
  # ------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: test

    # Branch-based deployment control
    if: ${{ github.ref_name == env.DEPLOY_BRANCH }}

    steps:
      - name: Deploy application
        run: |
          echo "Deploying ${APP_NAME}"
          echo "Using version: ${{ needs.build.outputs.build_version }}"
          echo "Deployment successful."

  # ------------------------------------------------------
  # NON-MAIN BRANCH MESSAGE
  # ------------------------------------------------------
  skip_deploy:
    runs-on: ubuntu-latest
    needs: test

    # Runs only if deploy condition is false
    if: ${{ github.ref_name != env.DEPLOY_BRANCH }}

    steps:
      - name: Deployment skipped
        run: |
          echo "Branch '${{ github.ref_name }}' is not allowed to deploy."
          echo "Build version was:"
          echo "${{ needs.build.outputs.build_version }}"
